# Gettting Started with Faust

Make sure you have Kafka running locally. If you don't already have a local cluster then you can use the docker compose in this repo.

```
docker-compose up
``` 

The dependencies are set up just using a dumb requirements.txt file.

```
pip install -r requirements.txt
```

Then to run the agent(s) use:

```
faust -A app.demo worker -l info
```

### What the Demo Agent Does

Overall this is a very simple toy pipeline that listens to a stream of purchases and aggregates them into a mapping from the customer to the total amount of money spent. The service also exposes an endpoint that allows a client to make a request to see how much money a given customer has spent (an example request would be a GET request to http://localhost:6066/customer/brian).

It listens to a topic ("purchase_topic") and consumes messages that are json representations of the type `PurchaseRecord`. `PurchaseRecord` is a subtype of a faust `Record`, which is basically a struct or named tuple with some optional niceities (in this example we declare the class using the argument `serializer="json"` which takes care of de/serialization for us).

It then invokes `handle_purchase` on each PurchaseRecord, which fetches the customer record from the customer_table and adds the purchase amount to the customer's total. Tables can largely be treated like dictionaries but they are persistant across restarts due to Faust storing a changelog of the collection on an autogenerated topic. Documentation is available [here](https://faust.readthedocs.io/en/latest/userguide/tables.html#tables).


### Sending Messages to the Agent

demo_producer has some simple functions for sending PurchaseRecords to the topic that the agent is listening to. In a new terminal window you can open up a new ipython terminal and do the following:

```
In [3]: from app.demo_producer import *
In [4]: send_purchases(make_random_purchases(10))
```

and you should see something like the following in the agent output:

```
[2020-04-02 12:10:21,821] [35583] [WARNING] Processing: 
[2020-04-02 12:10:21,822] [35583] [WARNING] <PurchaseRecord: msg_id='a506a5f2-a14b-4b5f-9bd6-42389494b32f', customer='brian', amount=11, note=None> 
[2020-04-02 12:10:21,822] [35583] [WARNING] brian has spent 55 so far. 
[2020-04-02 12:10:21,823] [35583] [WARNING] Processing: 
[2020-04-02 12:10:21,823] [35583] [WARNING] <PurchaseRecord: msg_id='8066dfb3-088a-4558-b08e-055d10fa79d4', customer='hamzah', amount=15, note=None> 
[2020-04-02 12:10:21,823] [35583] [WARNING] hamzah has spent 75 so far. 
[2020-04-02 12:10:21,823] [35583] [WARNING] Processing: 
[2020-04-02 12:10:21,824] [35583] [WARNING] <PurchaseRecord: msg_id='cfe309f2-d1c5-4efc-b3fe-1d610f9e6a20', customer='brian', amount=9, note=None> 
[2020-04-02 12:10:21,824] [35583] [WARNING] brian has spent 64 so far. 
[2020-04-02 12:10:21,824] [35583] [WARNING] Processing: 
[2020-04-02 12:10:21,824] [35583] [WARNING] <PurchaseRecord: msg_id='625192de-4a95-4e31-83c2-331b686051e6', customer='meher', amount=7, note=None> 
[2020-04-02 12:10:21,824] [35583] [WARNING] meher has spent 16 so far. 
```

**Resources**

[Faust Documentation](https://faust.readthedocs.io/en/latest/playbooks/quickstart.html)
